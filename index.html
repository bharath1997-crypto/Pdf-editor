<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced PDF Editor</title>
    <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.6.0/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 1200px;
            margin: 20px auto;
        }
        h2 {
            margin-bottom: 20px;
            color: #007BFF;
        }
        input[type="file"] {
            display: block;
            margin: 10px auto;
            padding: 10px;
            border: 2px dashed #007BFF;
            border-radius: 5px;
            cursor: pointer;
            background-color: #f9f9f9;
            color: #007BFF;
        }
        .toolbar {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .toolbar button {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }
        .toolbar button:hover {
            background-color: #0056b3;
        }
        .toolbar button.warning {
            background-color: #ffc107;
            color: #000;
        }
        .toolbar button.warning:hover {
            background-color: #e0a800;
        }
        .toolbar button.success {
            background-color: #28a745;
            color: #fff;
        }
        .toolbar button.success:hover {
            background-color: #218838;
        }
        .toolbar button.danger {
            background-color: #dc3545;
            color: #fff;
        }
        .toolbar button.danger:hover {
            background-color: #c82333;
        }
        .page-navigation {
            margin-top: 15px;
            text-align: center;
        }
        .page-navigation button {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }
        .page-navigation button:hover {
            background-color: #0056b3;
        }
        .sidebar {
            width: 150px;
            margin-right: 20px;
            overflow-y: auto;
        }
        .sidebar img {
            width: 100%;
            margin-bottom: 10px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .sidebar img.active {
            border-color: #007BFF;
        }
        .main-content {
            display: flex;
            width: 100%;
        }
        canvas {
            border: 1px solid #ccc;
            margin-top: 10px;
            border-radius: 5px;
            width: 100%;
            height: auto;
        }
        .cursor {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Advanced PDF Editor</h2>
        <input type="file" id="upload-pdf" accept="application/pdf">
        <div class="toolbar">
            <button onclick="addText()">Add Text</button>
            <button onclick="addRectangle()">Add Rectangle</button>
            <button onclick="addCircle()">Add Circle</button>
            <button onclick="addEllipse()">Add Ellipse</button>
            <button onclick="addPolygon()">Add Polygon</button>
            <button onclick="addStamp('Approved')">Add Stamp</button>
            <button onclick="addHighlight()">Add Highlight</button>
            <button onclick="addArrow()">Add Arrow</button>
            <button onclick="addComment()">Add Comment</button>
            <button onclick="enableDrawing()">Freehand Drawing</button>
            <button onclick="undo()">Undo</button>
            <button onclick="redo()">Redo</button>
            <button onclick="zoomIn()">Zoom In</button>
            <button onclick="zoomOut()">Zoom Out</button>
            <button class="success" onclick="saveState()">Save</button>
            <button class="warning" onclick="loadState()">Load</button>
            <button class="success" onclick="downloadPDF()">Download PDF</button>
            <button class="danger" onclick="printPDF()">Print PDF</button>
            <button class="success" onclick="saveToGoogleDrive()">Save to Google Drive</button>
            <button class="warning" onclick="loadFromGoogleDrive()">Load from Google Drive</button>
        </div>
        <div class="main-content">
            <div class="sidebar" id="sidebar"></div>
            <div>
                <div class="page-navigation">
                    <button onclick="prevPage()">Previous</button>
                    <span id="page-num">Page 1</span>
                    <button onclick="nextPage()">Next</button>
                </div>
                <canvas id="pdf-canvas"></canvas>
            </div>
        </div>
    </div>

    <script>
        let pdfDoc = null;
        let currentPage = 1;
        let scale = 1.5;
        let canvas = document.getElementById("pdf-canvas");
        let ctx = canvas.getContext("2d");
        let fabricCanvas = new fabric.Canvas("pdf-canvas");
        let undoStack = [];
        let redoStack = [];
        let isDrawingMode = false;
        let cursors = {};

        // WebSocket for Collaboration
        const socket = io("https://your-socket-server-url");
        socket.on("update", (data) => {
            fabricCanvas.loadFromJSON(data, () => {
                fabricCanvas.renderAll();
            });
        });

        socket.on("cursor", (data) => {
            if (!cursors[data.userId]) {
                cursors[data.userId] = document.createElement("div");
                cursors[data.userId].className = "cursor";
                document.body.appendChild(cursors[data.userId]);
            }
            cursors[data.userId].style.left = `${data.x}px`;
            cursors[data.userId].style.top = `${data.y}px`;
        });

        // Google Drive API Integration
        function initGoogleDrive() {
            gapi.load('client:auth2', () => {
                gapi.client.init({
                    apiKey: 'YOUR_API_KEY',
                    clientId: 'YOUR_CLIENT_ID',
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                    scope: 'https://www.googleapis.com/auth/drive.file',
                }).then(() => {
                    console.log("Google Drive API initialized.");
                });
            });
        }

        function saveToGoogleDrive() {
            gapi.auth2.getAuthInstance().signIn().then(() => {
                const fileContent = JSON.stringify(fabricCanvas.toJSON());
                const file = new Blob([fileContent], { type: 'application/json' });
                const metadata = {
                    name: 'pdf-editor-state.json',
                    mimeType: 'application/json',
                };
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', file);

                fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token }),
                    body: form,
                }).then((response) => response.json()).then((data) => {
                    console.log("File saved to Google Drive:", data);
                });
            });
        }

        function loadFromGoogleDrive() {
            gapi.auth2.getAuthInstance().signIn().then(() => {
                gapi.client.drive.files.list({
                    q: "name='pdf-editor-state.json'",
                    fields: 'files(id, name)',
                }).then((response) => {
                    const fileId = response.result.files[0].id;
                    gapi.client.drive.files.get({
                        fileId: fileId,
                        alt: 'media',
                    }).then((response) => {
                        fabricCanvas.loadFromJSON(response.body, () => {
                            fabricCanvas.renderAll();
                        });
                    });
                });
            });
        }

        // Load PDF
        document.getElementById("upload-pdf").addEventListener("change", async (event) => {
            let file = event.target.files[0];
            if (file) {
                let fileReader = new FileReader();
                fileReader.onload = async function() {
                    let typedArray = new Uint8Array(this.result);
                    pdfDoc = await pdfjsLib.getDocument({ data: typedArray }).promise;
                    currentPage = 1;
                    renderPDF();
                    renderThumbnails();
                };
                fileReader.readAsArrayBuffer(file);
            }
        });

        // Render PDF Page
        async function renderPDF() {
            if (!pdfDoc) return;
            let page = await pdfDoc.getPage(currentPage);
            let viewport = page.getViewport({ scale });
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            let renderContext = { canvasContext: ctx, viewport: viewport };
            await page.render(renderContext).promise;
            document.getElementById("page-num").innerText = `Page ${currentPage} of ${pdfDoc.numPages}`;
        }

        // Render Thumbnails
        async function renderThumbnails() {
            let sidebar = document.getElementById("sidebar");
            sidebar.innerHTML = "";
            for (let i = 1; i <= pdfDoc.numPages; i++) {
                let page = await pdfDoc.getPage(i);
                let viewport = page.getViewport({ scale: 0.2 });
                let thumbnailCanvas = document.createElement("canvas");
                thumbnailCanvas.width = viewport.width;
                thumbnailCanvas.height = viewport.height;
                let thumbnailCtx = thumbnailCanvas.getContext("2d");
                await page.render({ canvasContext: thumbnailCtx, viewport }).promise;
                let img = document.createElement("img");
                img.src = thumbnailCanvas.toDataURL();
                img.onclick = () => {
                    currentPage = i;
                    renderPDF();
                    updateThumbnails();
                };
                sidebar.appendChild(img);
            }
            updateThumbnails();
        }

        // Update Thumbnails
        function updateThumbnails() {
            let thumbnails = document.querySelectorAll(".sidebar img");
            thumbnails.forEach((img, index) => {
                img.classList.toggle("active", index + 1 === currentPage);
            });
        }

        // Add Text
        function addText() {
            let text = new fabric.Textbox("Editable Text", {
                left: 50,
                top: 50,
                fontSize: 20,
                fill: "#007BFF",
                fontFamily: "Arial",
            });
            fabricCanvas.add(text);
            saveState();
        }

        // Add Rectangle
        function addRectangle() {
            let rect = new fabric.Rect({
                left: 100,
                top: 100,
                width: 100,
                height: 50,
                fill: "transparent",
                stroke: "#007BFF",
                strokeWidth: 2,
            });
            fabricCanvas.add(rect);
            saveState();
        }

        // Add Circle
        function addCircle() {
            let circle = new fabric.Circle({
                left: 100,
                top: 100,
                radius: 50,
                fill: "transparent",
                stroke: "#007BFF",
                strokeWidth: 2,
            });
            fabricCanvas.add(circle);
            saveState();
        }

        // Add Ellipse
        function addEllipse() {
            let ellipse = new fabric.Ellipse({
                left: 100,
                top: 100,
                rx: 75,
                ry: 50,
                fill: "transparent",
                stroke: "#007BFF",
                strokeWidth: 2,
            });
            fabricCanvas.add(ellipse);
            saveState();
        }

        // Add Polygon
        function addPolygon() {
            let polygon = new fabric.Polygon([
                { x: 100, y: 0 },
                { x: 200, y: 50 },
                { x: 150, y: 150 },
                { x: 50, y: 150 },
                { x: 0, y: 50 },
            ], {
                fill: "transparent",
                stroke: "#007BFF",
                strokeWidth: 2,
            });
            fabricCanvas.add(polygon);
            saveState();
        }

        // Add Stamp
        function addStamp(text) {
            let stamp = new fabric.Textbox(text, {
                left: 50,
                top: 50,
                fontSize: 30,
                fill: "#007BFF",
                fontFamily: "Arial",
                fontWeight: "bold",
                textBackgroundColor: "#ffc107",
                padding: 10,
            });
            fabricCanvas.add(stamp);
            saveState();
        }

        // Add Highlight
        function addHighlight() {
            let rect = new fabric.Rect({
                left: 100,
                top: 100,
                width: 100,
                height: 50,
                fill: "#ffc107",
                opacity: 0.5,
            });
            fabricCanvas.add(rect);
            saveState();
        }

        // Add Arrow
        function addArrow() {
            let line = new fabric.Line([50, 100, 150, 100], {
                stroke: "#007BFF",
                strokeWidth: 2,
                fill: "#007BFF",
                strokeDashArray: [5, 5],
                pointer: true,
            });
            fabricCanvas.add(line);
            saveState();
        }

        // Add Comment
        function addComment() {
            let text = new fabric.Textbox("Comment", {
                left: 50,
                top: 50,
                fontSize: 16,
                fill: "#000",
                fontFamily: "Arial",
                backgroundColor: "#ffc107",
                padding: 5,
            });
            fabricCanvas.add(text);
            saveState();
        }

        // Enable Freehand Drawing
        function enableDrawing() {
            isDrawingMode = !isDrawingMode;
            fabricCanvas.isDrawingMode = isDrawingMode;
            saveState();
        }

        // Undo
        function undo() {
            if (undoStack.length > 1) {
                redoStack.push(undoStack.pop());
                fabricCanvas.loadFromJSON(undoStack[undoStack.length - 1]);
                fabricCanvas.renderAll();
            }
        }

        // Redo
        function redo() {
            if (redoStack.length > 0) {
                undoStack.push(redoStack.pop());
                fabricCanvas.loadFromJSON(undoStack[undoStack.length - 1]);
                fabricCanvas.renderAll();
            }
        }

        // Zoom In
        function zoomIn() {
            scale += 0.1;
            renderPDF();
        }

        // Zoom Out
        function zoomOut() {
            scale -= 0.1;
            renderPDF();
        }

        // Save State
        function saveState() {
            undoStack.push(JSON.stringify(fabricCanvas.toJSON()));
            redoStack = [];
            socket.emit("update", JSON.stringify(fabricCanvas.toJSON()));
        }

        // Load State
        function loadState() {
            let state = prompt("Paste the saved state:");
            if (state) {
                fabricCanvas.loadFromJSON(state, () => {
                    fabricCanvas.renderAll();
                });
            }
        }

        // Download PDF
        async function downloadPDF() {
            if (!pdfDoc) {
                alert("Please upload a PDF first.");
                return;
            }

            // Convert canvas to image
            let image = fabricCanvas.toDataURL({
                format: "png",
                quality: 1,
            });

            // Create a new PDF with PDF-Lib
            const newPdfDoc = await PDFLib.PDFDocument.create();
            const page = newPdfDoc.addPage();

            // Embed the image into the PDF
            const pngImage = await newPdfDoc.embedPng(image);
            page.drawImage(pngImage, {
                x: 0,
                y: 0,
                width: page.getWidth(),
                height: page.getHeight(),
            });

            // Save the PDF
            const pdfBytes = await newPdfDoc.save();
            const blob = new Blob([pdfBytes], { type: "application/pdf" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "modified-pdf.pdf";
            link.click();
        }

        // Print PDF
        function printPDF() {
            window.print();
        }

        // Page Navigation
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderPDF();
                updateThumbnails();
            }
        }

        function nextPage() {
            if (currentPage < pdfDoc.numPages) {
                currentPage++;
                renderPDF();
                updateThumbnails();
            }
        }

        // Initialize Google Drive API
        initGoogleDrive();

        // Track Cursor Movement
        document.addEventListener("mousemove", (event) => {
            socket.emit("cursor", {
                userId: socket.id,
                x: event.clientX,
                y: event.clientY,
            });
        });
    </script>
</body>
</html>
